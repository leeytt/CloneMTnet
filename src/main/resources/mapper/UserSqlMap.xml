<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.leeyunt.clonemtnet.dao.UserDao">
    <cache eviction="LRU" flushInterval="30000" size="512" readOnly="true"/>

    <!--登录检查-->
    <select id="findByUsername" parameterType="string" resultType="User">
        SELECT * FROM sys_user WHERE username=#{username}
    </select>

    <!--根据id查询用户-->
    <select id="findById" parameterType="int" resultType="User">
        SELECT id,username,nickname,role_id,headImg_url,phone,email,birthday,sex,create_time,update_time,status FROM sys_user WHERE id=#{id}
    </select>

    <!--获取当前登录用户的信息（角色、权限、菜单）-->
    <select id="getUserInfo" resultMap="userInfoMap">
        SELECT
            u.id as userId,
            u.username,
            u.nickname,
            u.role_id as roleId,
            r.role_name as roleName,
            p.menu_code as menuCode,
            p.permission_code as permissionCode
        FROM
            sys_user u
            LEFT JOIN sys_role r ON r.id = u.role_id
            LEFT JOIN sys_role_permission rp ON u.role_id = rp.role_id
            LEFT JOIN sys_permission p ON rp.permission_id = p.id
        WHERE
            u.username =  #{username}
            AND u.status = 1
    </select>
    <resultMap id="userInfoMap" type="One2Many">
        <id column="userId" property="userId"/>
        <result column="username" property="username"/>
        <result column="nickname" property="nickname"/>
        <result column="roleId" property="roleId"/>
        <result column="roleName" property="roleName"/>
        <collection property="menuList" ofType="String">
            <id column="menuCode" property="menuCode"/>
        </collection>
        <collection property="permissionList" ofType="String">
            <id column="permissionCode" property="permissionCode"/>
        </collection>
    </resultMap>

    <!-- 获取用户列表 -->
    <select id="listUser" resultMap="userMap">
        SELECT
            u.*,
            r.role_name roleName
        FROM
            (
            SELECT
                id userId,
                username username,
                nickname nickname,
                role_id roleId,
                sex sex,
                phone phone,
                email email,
                STATUS STATUS,
                DATE_FORMAT( create_time, '%Y-%m-%d %T' ) createTime,
                DATE_FORMAT( update_time, '%Y-%m-%d %T' ) updateTime
            FROM
                sys_user
            ORDER BY
                id
            ) u
            LEFT JOIN sys_role r ON r.id = u.roleId
        ORDER BY
            u.userId
    </select>
    <resultMap id="userMap" type="One2Many">
        <result column="userId" property="userId" />
        <result column="username" property="username" />
        <result column="nickname" property="nickname" />
        <result column="roleId" property="roleId" />
        <result column="roleName" property="roleName" />
        <result column="sex" property="sex" />
        <result column="phone" property="phone" />
        <result column="email" property="email" />
        <result column="status" property="status" />
        <result column="createTime" property="createTime" />
        <result column="updateTime" property="updateTime" />
    </resultMap>

    <!--根据map动态查询-->
    <select id="dynamicSelect" parameterType="map" resultType="User">
        select id,username,nickname,role_id,headImg_url,phone,email,birthday,sex,create_time,update_time,status from sys_user
        <where>
            <if test="id!=null">and sys_user.id=#{id} </if>
            <if test="username!=null">and sys_user.username=#{username} </if>
            <if test="nickname!=null">and sys_user.nickname=#{nickname} </if>
            <if test="role_id!=null">and sys_user.role_id=#{role_id} </if>
            <if test="headimg_url!=null">and sys_user.headimg_url=#{headimg_url} </if>
            <if test="phone!=null">and sys_user.phone=#{phone} </if>
            <if test="email!=null">and sys_user.email=#{email}</if>
            <if test="birthday!=null">and sys_user.birthday=#{birthday} </if>
            <if test="sex!=null">and sys_user.sex=#{sex} </if>
            <if test="status!=null">and sys_user.status=#{status} </if>
        </where>
        <if test="orderByCase!=null">order by sys_user.${orderByCase}</if>
        <if test="startPos!=null and pageSize!=null">limit #{startPos},#{pageSize}</if>
    </select>

    <!--根据map查询总记录数-->
    <select id="getUserCount" parameterType="map" resultType="long">select Count(*) from sys_user
        <where>
            <if test="id!=null">and sys_user.id=#{id} </if>
            <if test="username!=null">and sys_user.username=#{username} </if>
            <if test="nickname!=null">and sys_user.nickname=#{nickname} </if>
            <if test="role_id!=null">and sys_user.role_id=#{role_id} </if>
            <if test="headimg_url!=null">and sys_user.headimg_url=#{headimg_url} </if>
            <if test="phone!=null">and sys_user.phone=#{phone} </if>
            <if test="email!=null">and sys_user.email=#{email}</if>
            <if test="birthday!=null">and sys_user.birthday=#{birthday} </if>
            <if test="sex!=null">and sys_user.sex=#{sex} </if>
            <if test="status!=null">and sys_user.status=#{status} </if>
        </where>
    </select>

</mapper>
